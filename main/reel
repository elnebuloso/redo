#!/usr/bin/env php
<?php

require __DIR__ . '/vendor/autoload.php';

use App\CommandConfigFactory;
use App\Commands\DynamicCommand;
use App\ConfigurationCompiler;
use App\ConfigurationProcessor;
use App\ProcessFactory;
use Symfony\Component\Console\Application;
use Symfony\Component\Finder\Finder;

$processor = new ConfigurationProcessor();
$compiler = new ConfigurationCompiler();

$configuration = $processor->process([
    __DIR__ . "/reel.yml"
]);

$properties = $compiler->compile($configuration["properties"]);

$app = new Application("reel", file_get_contents('/VERSION'));
$app->add(new \App\Commands\PropertiesCommand());

loadReelCommands($app);
loadCustomCommands($app);

$app->run();

/**
 * @param Application $app
 * @return void
 */
function loadReelCommands(Application $app): void
{
    loadCommands($app, __DIR__ . "/commands");
}

/**
 * @param Application $app
 * @return void
 */
function loadCustomCommands(Application $app): void
{
    loadCommands($app, getcwd() . "/.reel/commands", "app");
}

/**
 * @param Application $app
 * @param string $directory
 * @param string $prefix
 * @return void
 */
function loadCommands(Application $app, string $directory, string $prefix = ""): void
{
    $finder = new Finder();
    $commandConfigFactory = new CommandConfigFactory($finder);
    $commandConfigDirectory = realpath($directory);

    if ($commandConfigDirectory) {
        foreach ($commandConfigFactory->createCommandConfigs($commandConfigDirectory, $prefix) as $commandConfig) {
            $app->add(new DynamicCommand($commandConfig, new ProcessFactory()));
        }
    }
}
