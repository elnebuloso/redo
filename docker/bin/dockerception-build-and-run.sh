#!/bin/bash

set -e

: "${REDO_DOCKERCEPTION_BUILD_TAG:=container}"
: "${REDO_DOCKERCEPTION_BUILD_CONTEXT:=.}"
: "${REDO_DOCKERCEPTION_FILE_NAME:=Dockerfile}"
: "${REDO_DOCKERCEPTION_FILE_TARGET:=dev-composer}"
: "${REDO_DOCKERCEPTION_RUN_DIR:=.}"
: "${REDO_DOCKERCEPTION_RUN_WORKDIR:=/app}"

ARGUMENTS=""

while [ $# -gt 0 ]; do
  case "$1" in
    --REDO_DOCKERCEPTION_BUILD_TAG=*)
      REDO_DOCKERCEPTION_BUILD_TAG="${1#*=}"
      ;;
    --REDO_DOCKERCEPTION_BUILD_CONTEXT=*)
      REDO_DOCKERCEPTION_BUILD_CONTEXT="${1#*=}"
      ;;
    --REDO_DOCKERCEPTION_FILE_NAME=*)
      REDO_DOCKERCEPTION_FILE_NAME="${1#*=}"
      ;;
    --REDO_DOCKERCEPTION_FILE_TARGET=*)
      REDO_DOCKERCEPTION_FILE_TARGET="${1#*=}"
      ;;
    --REDO_DOCKERCEPTION_RUN_DIR=*)
      REDO_DOCKERCEPTION_RUN_DIR="${1#*=}"
      ;;
    --REDO_DOCKERCEPTION_RUN_WORKDIR=*)
      REDO_DOCKERCEPTION_RUN_WORKDIR="${1#*=}"
      ;;
    *)
      ARGUMENTS="$ARGUMENTS $1"
  esac
  shift
done

ARGS=""
ARGS="$ARGS --rm --pull"
ARGS="$ARGS --file $REDO_DOCKERCEPTION_FILE_NAME"
ARGS="$ARGS --target $REDO_DOCKERCEPTION_FILE_TARGET"

TAG=$(echo $ARGS | md5sum | awk '{print $1}')
TAG="redo-tmp-$REDO_DOCKERCEPTION_BUILD_TAG-$TAG"

BUILD_CMD="docker build $ARGS --tag $TAG $REDO_DOCKERCEPTION_BUILD_CONTEXT"

if [[ ${REDO_VERBOSE_LEVEL} -ge 2 ]]; then
  echo -e "\e[36m${BUILD_CMD}\e[0m"
fi

$BUILD_CMD
dockerception-run $REDO_DOCKERCEPTION_RUN_DIR $REDO_DOCKERCEPTION_RUN_WORKDIR $TAG $ARGUMENTS
