#!/bin/bash

set -e

: "${REDO_DOCKERCEPTION_BUILD_TAG:=container}"
: "${REDO_DOCKERCEPTION_BUILD_CONTEXT:=.}"
: "${REDO_DOCKERCEPTION_FILE_NAME:=Dockerfile}"
: "${REDO_DOCKERCEPTION_FILE_TARGET:=dev-composer}"
: "${REDO_DOCKERCEPTION_RUN_DIR:=.}"
: "${REDO_DOCKERCEPTION_RUN_WORKDIR:=/app}"

_ARGS_=()

while [ $# -gt 0 ]; do
  case "$1" in
  --REDO_DOCKERCEPTION_BUILD_TAG=*)
    REDO_DOCKERCEPTION_BUILD_TAG="${1#*=}"
    ;;
  --REDO_DOCKERCEPTION_BUILD_CONTEXT=*)
    REDO_DOCKERCEPTION_BUILD_CONTEXT="${1#*=}"
    ;;
  --REDO_DOCKERCEPTION_FILE_NAME=*)
    REDO_DOCKERCEPTION_FILE_NAME="${1#*=}"
    ;;
  --REDO_DOCKERCEPTION_FILE_TARGET=*)
    REDO_DOCKERCEPTION_FILE_TARGET="${1#*=}"
    ;;
  --REDO_DOCKERCEPTION_RUN_DIR=*)
    REDO_DOCKERCEPTION_RUN_DIR="${1#*=}"
    ;;
  --REDO_DOCKERCEPTION_RUN_WORKDIR=*)
    REDO_DOCKERCEPTION_RUN_WORKDIR="${1#*=}"
    ;;
  *)
    _ARGS_+=($1)
    ;;
  esac
  shift
done

_MD5_DOCKERFILE_=$(md5sum $REDO_DOCKERCEPTION_FILE_NAME | awk '{print $1}')

_TAG_ARGS_=()
_TAG_ARGS_+=("MD5_DOCKERFILE:$_MD5_DOCKERFILE_")
_TAG_ARGS_+=("REDO_DOCKERCEPTION_BUILD_TAG:$REDO_DOCKERCEPTION_BUILD_TAG")
_TAG_ARGS_+=("REDO_DOCKERCEPTION_BUILD_CONTEXT:$REDO_DOCKERCEPTION_BUILD_CONTEXT")
_TAG_ARGS_+=("REDO_DOCKERCEPTION_FILE_NAME:$REDO_DOCKERCEPTION_FILE_NAME")
_TAG_ARGS_+=("REDO_DOCKERCEPTION_FILE_TARGET:$REDO_DOCKERCEPTION_FILE_TARGET")

_TAG_=$(echo "${_TAG_ARGS_[*]}" | md5sum | awk '{print $1}')
_TAG_="redo-tmp-$REDO_DOCKERCEPTION_BUILD_TAG-$_TAG_"

_BUILD_=()
_BUILD_+=("docker")
_BUILD_+=("build")
_BUILD_+=("--rm")
_BUILD_+=("--pull")
_BUILD_+=("--file $REDO_DOCKERCEPTION_FILE_NAME")
_BUILD_+=("--target $REDO_DOCKERCEPTION_FILE_TARGET")
_BUILD_+=("--tag $_TAG_")
_BUILD_+=("$REDO_DOCKERCEPTION_BUILD_CONTEXT")

if [[ "$(docker images -q $_TAG_ 2>/dev/null)" == "" ]]; then
  if [[ ${REDO_VERBOSE_LEVEL} -ge 2 ]]; then
    echo -e "\e[36m${_BUILD_[*]}\e[0m"
  fi

  ${_BUILD_[*]}
fi

dockerception-run $REDO_DOCKERCEPTION_RUN_DIR $REDO_DOCKERCEPTION_RUN_WORKDIR $_TAG_ ${_ARGS_[*]}
