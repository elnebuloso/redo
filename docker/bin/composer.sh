#!/bin/bash

set -e

: "${REDO_COMPOSER_DIR:=main}"
: "${REDO_COMPOSER_DOCKER_BUILD_CONTEXT:=.}"
: "${REDO_COMPOSER_DOCKER_BUILD_ARGS:=--rm --pull}"
: "${REDO_COMPOSER_DOCKER_FILE_NAME:=Dockerfile}"
: "${REDO_COMPOSER_DOCKER_FILE_TARGET:=dev-composer}"

_ARGS_=()

while [ $# -gt 0 ]; do
  case "$1" in
  --REDO_COMPOSER_DIR=*)
    REDO_COMPOSER_DIR="${1#*=}"
    ;;
  --REDO_COMPOSER_DOCKER_BUILD_CONTEXT=*)
    REDO_COMPOSER_DOCKER_BUILD_CONTEXT="${1#*=}"
    ;;
  --REDO_COMPOSER_DOCKER_BUILD_ARGS=*)
    REDO_COMPOSER_DOCKER_BUILD_ARGS="${1#*=}"
    ;;
  --REDO_COMPOSER_DOCKER_FILE_NAME=*)
    REDO_COMPOSER_DOCKER_FILE_NAME="${1#*=}"
    ;;
  --REDO_COMPOSER_DOCKER_FILE_TARGET=*)
    REDO_COMPOSER_DOCKER_FILE_TARGET="${1#*=}"
    ;;
  *)
    _ARGS_+=($1)
    ;;
  esac
  shift
done

: "${REDO_DOCKERCEPTION_BUILD_CONTEXT:=.}"
: "${REDO_DOCKERCEPTION_FILE_NAME:=Dockerfile}"
: "${REDO_DOCKERCEPTION_FILE_TARGET:=dev-composer}"
: "${REDO_DOCKERCEPTION_RUN_DIR:=.}"
: "${REDO_DOCKERCEPTION_RUN_WORKDIR:=/app}"

_ARGS_RUN_=()
_ARGS_RUN_+=("--REDO_DOCKERCEPTION_BUILD_TAG=composer")
_ARGS_RUN_+=("--REDO_DOCKERCEPTION_BUILD_CONTEXT=$REDO_COMPOSER_DOCKER_BUILD_CONTEXT")
_ARGS_RUN_+=("--REDO_DOCKERCEPTION_FILE_NAME=$REDO_COMPOSER_DOCKER_FILE_NAME")
_ARGS_RUN_+=("--REDO_DOCKERCEPTION_FILE_TARGET=$REDO_COMPOSER_DOCKER_FILE_TARGET")
_ARGS_RUN_+=("--REDO_DOCKERCEPTION_RUN_DIR=$REDO_COMPOSER_DIR")
_ARGS_RUN_+=("--REDO_DOCKERCEPTION_RUN_WORKDIR=/app")

dockerception-build-and-run ${_ARGS_RUN_[*]} composer ${_ARGS_[*]}
