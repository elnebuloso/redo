#!/bin/bash

set -e

: "${REEL_COMPOSER_DIR:=main}"
: "${REEL_COMPOSER_DOCKER_BUILD_CONTEXT:=.}"
: "${REEL_COMPOSER_DOCKER_BUILD_ARGS:=--rm --pull}"
: "${REEL_COMPOSER_DOCKER_FILE_NAME:=Dockerfile}"
: "${REEL_COMPOSER_DOCKER_FILE_TARGET:=dev-composer}"

_ARGS_=()

while [ $# -gt 0 ]; do
  case "$1" in
  --REEL_COMPOSER_DIR=*)
    REEL_COMPOSER_DIR="${1#*=}"
    ;;
  --REEL_COMPOSER_DOCKER_BUILD_CONTEXT=*)
    REEL_COMPOSER_DOCKER_BUILD_CONTEXT="${1#*=}"
    ;;
  --REEL_COMPOSER_DOCKER_BUILD_ARGS=*)
    REEL_COMPOSER_DOCKER_BUILD_ARGS="${1#*=}"
    ;;
  --REEL_COMPOSER_DOCKER_FILE_NAME=*)
    REEL_COMPOSER_DOCKER_FILE_NAME="${1#*=}"
    ;;
  --REEL_COMPOSER_DOCKER_FILE_TARGET=*)
    REEL_COMPOSER_DOCKER_FILE_TARGET="${1#*=}"
    ;;
  *)
    _ARGS_+=($1)
    ;;
  esac
  shift
done

: "${REEL_DOCKERCEPTION_BUILD_CONTEXT:=.}"
: "${REEL_DOCKERCEPTION_FILE_NAME:=Dockerfile}"
: "${REEL_DOCKERCEPTION_FILE_TARGET:=dev-composer}"
: "${REEL_DOCKERCEPTION_RUN_DIR:=.}"
: "${REEL_DOCKERCEPTION_RUN_WORKDIR:=/app}"

_ARGS_RUN_=()
_ARGS_RUN_+=("--REEL_DOCKERCEPTION_BUILD_TAG=composer")
_ARGS_RUN_+=("--REEL_DOCKERCEPTION_BUILD_CONTEXT=$REEL_COMPOSER_DOCKER_BUILD_CONTEXT")
_ARGS_RUN_+=("--REEL_DOCKERCEPTION_FILE_NAME=$REEL_COMPOSER_DOCKER_FILE_NAME")
_ARGS_RUN_+=("--REEL_DOCKERCEPTION_FILE_TARGET=$REEL_COMPOSER_DOCKER_FILE_TARGET")
_ARGS_RUN_+=("--REEL_DOCKERCEPTION_RUN_DIR=$REEL_COMPOSER_DIR")
_ARGS_RUN_+=("--REEL_DOCKERCEPTION_RUN_WORKDIR=/app")

dockerception-build-and-run ${_ARGS_RUN_[*]} composer ${_ARGS_[*]}
